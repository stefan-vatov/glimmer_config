---
- name: Set vars
  ansible.builtin.set_fact:
    homebrew_packages_brew_bin: /opt/homebrew/bin/brew
  tags:
    - setup

- name: Check if Homebrew is installed
  ansible.builtin.stat:
    path: "{{ homebrew_packages_brew_bin }}"
  register: homebrew_packages_brew_check
  tags:
    - setup

- name: Install Homebrew if not present
  ansible.builtin.shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  args:
    creates: "{{ homebrew_packages_brew_bin }}"
  when: not homebrew_packages_brew_check.stat.exists
  tags:
    - setup
    - skip_ansible_lint

- name: Tap taps
  ansible.builtin.command:
    cmd: brew tap {{ item }}
  loop: "{{ homebrew_taps }}"
  changed_when: false
  tags:
    - setup

- name: Count packages to install
  ansible.builtin.set_fact:
    homebrew_packages_total_packages: "{{ homebrew_packages_list | length }}"
  tags:
    - setup

- name: Install Homebrew packages
  community.general.homebrew:
    name: "{{ item }}"
    state: latest
  loop: "{{ homebrew_packages_list }}"
  loop_control:
    index_var: pkg_index
  become: false
  register: homebrew_packages_pkg_result
  tags:
    - setup

- name: Show package installation progress
  ansible.builtin.debug:
    msg: "Installing package {{ pkg_index + 1 }} of {{ homebrew_packages_total_packages }}: {{ item }}"
  loop: "{{ homebrew_packages_list }}"
  loop_control:
    index_var: pkg_index
  when: homebrew_packages_pkg_result is not defined or homebrew_packages_pkg_result.changed
  tags:
    - setup

- name: Install packages using Homebrew --cask
  ansible.builtin.shell:
    cmd: brew install --cask --force {{ item }}
  loop: "{{ cask_packages }}"
  tags:
    - setup
    - skip_ansible_lint

- name: Install emacs-plus with native-comp
  ansible.builtin.command: brew install emacs-plus --with-native-comp
  become: false
  changed_when: false
  tags:
    - setup
