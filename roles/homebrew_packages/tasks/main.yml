---
- name: Run homebrew pre-flight checks
  ansible.builtin.include_tasks: preflight.yml
  tags: [always, preflight]
- name: Set vars
  ansible.builtin.set_fact:
    homebrew_packages_brew_bin: /opt/homebrew/bin/brew
  tags:
    - setup

- name: Check if Homebrew is installed
  ansible.builtin.stat:
    path: "{{ homebrew_packages_brew_bin }}"
  register: homebrew_packages_brew_check
  tags:
    - setup

- name: Install Homebrew if not present
  ansible.builtin.shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  args:
    creates: "{{ homebrew_packages_brew_bin }}"
  when: not homebrew_packages_brew_check.stat.exists
  tags:
    - setup
    - skip_ansible_lint

- name: Determine Homebrew prefix
  ansible.builtin.command:
    cmd: brew --prefix
  register: homebrew_packages_prefix
  changed_when: false
  failed_when: false
  tags:
    - setup

- name: Check if Homebrew prefix is writable
  ansible.builtin.stat:
    path: "{{ homebrew_packages_prefix.stdout | trim }}"
  register: homebrew_packages_prefix_stat
  when: homebrew_packages_prefix.rc == 0 and (homebrew_packages_prefix.stdout | trim) != ""
  tags:
    - setup

- name: Set Homebrew writable flag
  ansible.builtin.set_fact:
    homebrew_packages_prefix_writable: "{{ homebrew_packages_prefix_stat.stat.writeable | default(false) }}"
  when: homebrew_packages_prefix_stat is defined
  tags:
    - setup

- name: Warn when Homebrew prefix is not writable
  ansible.builtin.debug:
    msg: "Homebrew prefix {{ homebrew_packages_prefix.stdout | trim }} is not writable for this user; skipping Homebrew taps/packages/casks."
  when: homebrew_packages_prefix.rc == 0 and not (homebrew_packages_prefix_writable | default(false))
  tags:
    - setup

- name: Tap taps
  ansible.builtin.command:
    cmd: brew tap {{ item }}
  loop: "{{ homebrew_taps }}"
  changed_when: false
  when: homebrew_packages_prefix_writable | default(false)
  tags:
    - setup

- name: Count packages to install
  ansible.builtin.set_fact:
    homebrew_packages_total_packages: "{{ homebrew_packages_list | length }}"
  tags:
    - setup

- name: Install Homebrew packages
  community.general.homebrew:
    name: "{{ item }}"
    state: latest
  loop: "{{ homebrew_packages_list }}"
  loop_control:
    index_var: pkg_index
  become: false
  register: homebrew_packages_pkg_result
  when: homebrew_packages_prefix_writable | default(false)
  tags:
    - setup

- name: Show package installation progress
  ansible.builtin.debug:
    msg: "Installing package {{ pkg_index + 1 }} of {{ homebrew_packages_total_packages }}: {{ item }}"
  loop: "{{ homebrew_packages_list }}"
  loop_control:
    index_var: pkg_index
  when: (homebrew_packages_prefix_writable | default(false)) and (homebrew_packages_pkg_result is not defined or homebrew_packages_pkg_result.changed)
  tags:
    - setup

- name: Install packages using Homebrew --cask
  ansible.builtin.shell:
    cmd: brew install --cask --force {{ item }}
  loop: "{{ cask_packages }}"
  when: not ansible_check_mode and (homebrew_packages_prefix_writable | default(false))
  tags:
    - setup
    - skip_ansible_lint
